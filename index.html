<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AgriConnect | Rwanda's Digital Agriculture Marketplace</title>
  <link rel="icon" href="assets/logo.png" type="image/png" />
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f3f4f6; color: #222; }
    nav { background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0.5em 2em; box-shadow: 0 2px 8px #0001; }
    nav .logo { height: 40px; }
    nav ul { list-style: none; display: flex; gap: 1.5em; margin: 0; padding: 0; }
    nav ul li { display: inline; }
    nav ul li a { text-decoration: none; color: #22c55e; font-weight: bold; }
    nav ul li a.active, nav ul li a:hover { color: #3b82f6; }
    main { min-height: 70vh; padding: 2em 1em; max-width: 900px; margin: auto; }
    .hero-bg { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; opacity: 0.7; }
    .hero-farmer { max-width: 200px; display: block; margin: 2em auto 0 auto; }
    .section { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #0001; padding: 2em; margin-bottom: 2em; }
    input, select, textarea, button { font-size: 1em; padding: 0.6em; margin-bottom: 1em; border-radius: 6px; border: 1px solid #e5e7eb; width: 100%; box-sizing: border-box; }
    button { background: #22c55e; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #3b82f6; }
    .product-list { display: flex; flex-wrap: wrap; gap: 1em; }
    .product-card { background: #f9fafb; border-radius: 8px; box-shadow: 0 1px 4px #0001; padding: 1em; width: 220px; }
    .product-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; }
    .chat-box { background: #f9fafb; border-radius: 8px; padding: 1em; margin-top: 2em; }
    footer { background: #fff; text-align: center; padding: 1.5em 0 1em 0; box-shadow: 0 -2px 8px #0001; margin-top: 2em; }
    .footer-logo { height: 32px; }
    .footer-desc { font-size: 0.9em; color: #666; margin-top: 0.5em; }
    .error { color: red; margin-bottom: 1em; }
    .hidden { display: none !important; }
    @media (max-width: 600px) { nav { flex-direction: column; align-items: flex-start; } .product-list { flex-direction: column; align-items: center; } }
  </style>
</head>
<body>
  <nav>
    <img src="assets/logo.png" alt="AgriConnect Logo" class="logo"/>
    <ul>
      <li><a href="#" id="nav-home" class="active">Home</a></li>
      <li><a href="#" id="nav-marketplace">Marketplace</a></li>
      <li><a href="#" id="nav-profile" style="display:none;">Profile</a></li>
      <li><a href="#" id="nav-admin" style="display:none;">Admin</a></li>
      <li><a href="#" id="nav-login">Login</a></li>
      <li><a href="#" id="nav-logout" style="display:none;">Logout</a></li>
    </ul>
  </nav>
  <main>
    <section id="page-home" class="section">
      <img src="assets/crops-bg.png" alt="Crops" class="hero-bg"/>
      <div class="hero-content">
        <h1>Welcome to AgriConnect</h1>
        <p>Empowering Rwandan farmers with direct market access, fair pricing, and essential financial services.</p>
        <img src="assets/farmer.png" alt="Farmer" class="hero-farmer"/>
      </div>
      <div class="auth-section">
        <div class="auth-box">
          <h2>Login</h2>
          <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required />
            <input type="password" id="login-password" placeholder="Password" required />
            <button type="submit">Login</button>
          </form>
          <div id="login-error" class="error"></div>
        </div>
        <div class="auth-box">
          <h2>Register</h2>
          <form id="register-form">
            <input type="email" id="reg-email" placeholder="Email" required />
            <input type="password" id="reg-password" placeholder="Password" required />
            <select id="reg-role">
              <option value="farmer">Farmer</option>
              <option value="buyer">Buyer</option>
            </select>
            <button type="submit">Register</button>
          </form>
          <div id="register-error" class="error"></div>
        </div>
      </div>
    </section>
    <section id="page-marketplace" class="section hidden">
      <h2>Marketplace</h2>
      <form id="product-form" style="display:none;">
        <input type="text" id="prod-name" placeholder="Product Name" required />
        <textarea id="prod-desc" placeholder="Description" required></textarea>
        <input type="number" id="prod-price" placeholder="Price (RWF)" required />
        <input type="file" id="prod-img" accept="image/*" />
        <button type="submit">Post Produce for Sale</button>
      </form>
      <div id="product-list" class="product-list"></div>
      <div class="chat-box">
        <h3>Community Chat</h3>
        <div id="chat-messages" class="chat-messages"></div>
        <form id="chat-form">
          <input type="text" id="chat-input" placeholder="Type a message..." required />
          <button type="submit">Send</button>
        </form>
      </div>
    </section>
    <section id="page-profile" class="section hidden">
      <h2>Profile</h2>
      <div id="profile-info"></div>
      <form id="loan-form" style="display:none;">
        <h3>Request Micro-Loan</h3>
        <input type="number" id="loan-amount" placeholder="Amount (RWF)" required />
        <textarea id="loan-purpose" placeholder="Purpose" required></textarea>
        <button type="submit">Request Loan</button>
      </form>
      <form id="logistics-form" style="display:none;">
        <h3>Request Logistics Service</h3>
        <textarea id="logistics-details" placeholder="Describe your delivery needs" required></textarea>
        <button type="submit">Request Logistics</button>
      </form>
    </section>
    <section id="page-admin" class="section hidden">
      <h2>Admin Dashboard</h2>
      <div id="admin-users"></div>
      <div id="admin-loans"></div>
      <div id="admin-logistics"></div>
    </section>
  </main>
  <footer>
    <img src="assets/logo.png" alt="AgriConnect Logo" class="footer-logo"/>
    <div>Â© <span id="year"></span> AgriConnect. All rights reserved.</div>
    <div class="footer-desc">Empowering Rwandan farmers and communities.</div>
  </footer>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // Replace with your Firebase config!
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
  </script>
  <script>
    function showSection(id) {
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('nav ul li a').forEach(a => a.classList.remove('active'));
      if (id === 'page-home') document.getElementById('nav-home').classList.add('active');
      if (id === 'page-marketplace') document.getElementById('nav-marketplace').classList.add('active');
      if (id === 'page-profile') document.getElementById('nav-profile').classList.add('active');
      if (id === 'page-admin') document.getElementById('nav-admin').classList.add('active');
    }
    function show(el, show = true) { if (el) el.style.display = show ? '' : 'none'; }
    document.getElementById('year').innerText = new Date().getFullYear();

    document.getElementById('nav-home').onclick = e => { e.preventDefault(); showSection('page-home'); };
    document.getElementById('nav-marketplace').onclick = e => { e.preventDefault(); showSection('page-marketplace'); };
    document.getElementById('nav-profile').onclick = e => { e.preventDefault(); showSection('page-profile'); };
    document.getElementById('nav-admin').onclick = e => { e.preventDefault(); showSection('page-admin'); };
    document.getElementById('nav-login').onclick = e => { e.preventDefault(); showSection('page-home'); };
    document.getElementById('nav-logout').onclick = e => { e.preventDefault(); auth.signOut(); location.reload(); };

    let currentUser = null;
    let currentRole = null;
    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        const doc = await db.collection('users').doc(user.uid).get();
        currentRole = doc.exists ? doc.data().role : null;
        show(document.getElementById('nav-login'), false);
        show(document.getElementById('nav-logout'), true);
        show(document.getElementById('nav-profile'), true);
        show(document.getElementById('nav-admin'), currentRole === 'admin');
        show(document.getElementById('product-form'), currentRole === 'farmer');
      } else {
        currentRole = null;
        show(document.getElementById('nav-login'), true);
        show(document.getElementById('nav-logout'), false);
        show(document.getElementById('nav-profile'), false);
        show(document.getElementById('nav-admin'), false);
        show(document.getElementById('product-form'), false);
      }
    });

    document.getElementById('login-form').onsubmit = function(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => { showSection('page-marketplace'); })
        .catch(err => document.getElementById('login-error').innerText = err.message);
    };
    document.getElementById('register-form').onsubmit = function(e) {
      e.preventDefault();
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;
      const role = document.getElementById('reg-role').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(cred => db.collection('users').doc(cred.user.uid).set({ email, role }))
        .then(() => { showSection('page-marketplace'); })
        .catch(err => document.getElementById('register-error').innerText = err.message);
    };

    function loadProducts() {
      db.collection('products').orderBy('createdAt', 'desc').get().then(snapshot => {
        const list = document.getElementById('product-list');
        list.innerHTML = '';
        snapshot.forEach(doc => {
          const p = doc.data();
          list.innerHTML += `
            <div class="product-card">
              <img src="${p.imageUrl || 'assets/icons.png'}" alt="${p.name}" />
              <div><b>${p.name}</b></div>
              <div>${p.description}</div>
              <div style="color:#3b82f6;font-weight:bold;">RWF ${p.price}</div>
            </div>
          `;
        });
      });
    }
    document.getElementById('product-form').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('prod-name').value;
      const description = document.getElementById('prod-desc').value;
      const price = document.getElementById('prod-price').value;
      const imgFile = document.getElementById('prod-img').files[0];
      let imageUrl = "";
      if (imgFile) {
        const ref = storage.ref('products/' + Date.now() + '_' + imgFile.name);
        ref.put(imgFile).then(snapshot => snapshot.ref.getDownloadURL())
          .then(url => {
            imageUrl = url;
            saveProduct(name, description, price, imageUrl);
          });
      } else {
        saveProduct(name, description, price, imageUrl);
      }
    };
    function saveProduct(name, description, price, imageUrl) {
      db.collection('products').add({
        name, description, price, imageUrl, farmerId: currentUser.uid, createdAt: new Date()
      }).then(() => {
        loadProducts();
        document.getElementById('product-form').reset();
      });
    }
    db.collection('chat').orderBy('createdAt', 'asc').onSnapshot(snapshot => {
      const chat = document.getElementById('chat-messages');
      chat.innerHTML = '';
      snapshot.forEach(doc => {
        const m = doc.data();
        chat.innerHTML += `<div><b>${m.user}:</b> ${m.text}</div>`;
      });
      chat.scrollTop = chat.scrollHeight;
    });
    document.getElementById('chat-form').onsubmit = function(e) {
      e.preventDefault();
      const text = document.getElementById('chat-input').value;
      db.collection('chat').add({
        text,
        user: currentUser ? currentUser.email : "Anonymous",
        createdAt: new Date()
      }).then(() => {
        document.getElementById('chat-input').value = '';
      });
    };

    function loadProfile() {
      if (!currentUser) return;
      db.collection('users').doc(currentUser.uid).get().then(doc => {
        const info = document.getElementById('profile-info');
        info.innerHTML = `<div><b>Email:</b> ${currentUser.email}</div>
          <div><b>Role:</b> ${doc.data().role}</div>`;
        if (doc.data().role === 'farmer') {
          show(document.getElementById('loan-form'), true);
          show(document.getElementById('logistics-form'), true);
        }
      });
    }
    document.getElementById('loan-form').onsubmit = function(e) {
      e.preventDefault();
      const amount = document.getElementById('loan-amount').value;
      const purpose = document.getElementById('loan-purpose').value;
      db.collection('loans').add({
        farmerId: currentUser.uid, amount, purpose, status: "pending", createdAt: new Date()
      }).then(() => alert("Loan requested!"));
    };
    document.getElementById('logistics-form').onsubmit = function(e) {
      e.preventDefault();
      const details = document.getElementById('logistics-details').value;
      db.collection('logistics').add({
        userId: currentUser.uid, details, status: "pending", createdAt: new Date()
      }).then(() => alert("Logistics requested!"));
    };

    function loadAdmin() {
      db.collection('users').get().then(snapshot => {
        const users = document.getElementById('admin-users');
        users.innerHTML = `<h3>Users</h3><ul>` +
          snapshot.docs.map(doc => `<li>${doc.data().email} - ${doc.data().role}</li>`).join('') +
          `</ul>`;
      });
      db.collection('loans').get().then(snapshot => {
        const loans = document.getElementById('admin-loans');
        loans.innerHTML = `<h3>Loan Requests</h3><ul>` +
          snapshot.docs.map(doc => {
            const l = doc.data();
            return `<li>${l.farmerId} - ${l.amount} RWF - ${l.status}</li>`;
          }).join('') + `</ul>`;
      });
      db.collection('logistics').get().then(snapshot => {
        const logistics = document.getElementById('admin-logistics');
        logistics.innerHTML = `<h3>Logistics Requests</h3><ul>` +
          snapshot.docs.map(doc => {
            const l = doc.data();
            return `<li>${l.userId} - ${l.details} - ${l.status}</li>`;
          }).join('') + `</ul>`;
      });
    }

    function onSectionShow(id) {
      if (id === 'page-marketplace') loadProducts();
      if (id === 'page-profile') loadProfile();
      if (id === 'page-admin') loadAdmin();
    }
    const observer = new MutationObserver(() => {
      ['page-home','page-marketplace','page-profile','page-admin'].forEach(id => {
        if (!document.getElementById(id).classList.contains('hidden')) onSectionShow(id);
      });
    });
    observer.observe(document.querySelector('main'), { attributes: true, subtree: true });

    showSection('page-home');
  </script>
</body>
</html>
